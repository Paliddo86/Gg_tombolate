<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Tombola Pro - Generatore PDF Vettoriale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; text-align: center; padding: 50px; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: inline-block; }
        input { padding: 10px; margin: 10px; border: 1px solid #ccc; width: 300px; display: block; margin: 10px auto; }
        button { padding: 12px 25px; cursor: pointer; background: #c0392b; color: white; border: none; font-weight: bold; border-radius: 4px; font-size: 16px; }
        button:hover { background: #a93226; }
        p { color: #666; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Generatore Cartelle PDF</h1>
    <p>Il file verr√† generato con 4 cartelle per pagina, layout identico al PDF originale.</p>
    
    <label>Titolo Personalizzato:</label>
    <input type="text" id="titoloInput" value="Tombola Gruppo Giovani V. Nigro">
    
    <label>Numero di Cartelle:</label>
    <input type="number" id="qty" value="12" min="1" style="width: 80px;">
    
    <button onclick="generatePDF()">SCARICA PDF PROFESSIONALE</button>
</div>

<script>
const { jsPDF } = window.jspdf;

// --- ALGORITMO: 5 numeri per riga, NO colonne vuote ---
function createTombolaMatrix() {
    let grid;
    let valid = false;
    while (!valid) {
        grid = Array.from({ length: 3 }, () => Array(9).fill(null));
        let rowCounts = [0, 0, 0];
        let colCounts = Array(9).fill(0);

        for (let c = 0; c < 9; c++) {
            let r = Math.floor(Math.random() * 3);
            grid[r][c] = true;
            rowCounts[r]++; colCounts[c]++;
        }

        while (rowCounts.some(count => count < 5)) {
            let r = rowCounts.findIndex(count => count < 5);
            let c = Math.floor(Math.random() * 9);
            if (grid[r][c] === null) {
                grid[r][c] = true;
                rowCounts[r]++; colCounts[c]++;
            }
        }
        if (colCounts.every(count => count > 0)) valid = true;
    }

    let columnsPool = Array.from({ length: 9 }, (_, i) => {
        let min = i === 0 ? 1 : i * 10;
        let max = i === 8 ? 90 : i * 10 + 9;
        let nums = [];
        for (let n = min; n <= max; n++) nums.push(n);
        return nums.sort(() => Math.random() - 0.5);
    });

    for (let c = 0; c < 9; c++) {
        let vals = [];
        for (let r = 0; r < 3; r++) if (grid[r][c] === true) vals.push(columnsPool[c].pop());
        vals.sort((a, b) => a - b);
        let idx = 0;
        for (let r = 0; r < 3; r++) if (grid[r][c] === true) grid[r][c] = vals[idx++];
    }
    return grid;
}

// --- GENERAZIONE PDF VETTORIALE ---
function generatePDF() {
    const doc = new jsPDF('p', 'mm', 'a4');
    const qty = parseInt(document.getElementById('qty').value);
    const titolo = document.getElementById('titoloInput').value.toUpperCase();

    const marginX = 10;
    const cardWidth = 190;
    const cardHeight = 65;
    const cellWidth = cardWidth / 9;
    const cellHeight = 16;

    for (let i = 0; i < qty; i++) {
        const pageIdx = i % 4;
        if (i > 0 && pageIdx === 0) doc.addPage();

        const startY = 15 + (pageIdx * 70);
        const matrix = createTombolaMatrix();

        // Intestazione Cartella
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text(`N. ${i + 1}`, marginX, startY - 2);
        doc.text(titolo, marginX + cardWidth, startY - 2, { align: "right" });

        // Disegno Tabella
        doc.setLineWidth(0.5);
        for (let r = 0; r <= 3; r++) {
            doc.line(marginX, startY + (r * cellHeight), marginX + cardWidth, startY + (r * cellHeight));
        }
        for (let c = 0; c <= 9; c++) {
            doc.line(marginX + (c * cellWidth), startY, marginX + (c * cellWidth), startY + (3 * cellHeight));
        }

        // Inserimento Numeri
        doc.setFontSize(28);
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < 9; c++) {
                if (matrix[r][c]) {
                    const txt = matrix[r][c].toString();
                    const x = marginX + (c * cellWidth) + (cellWidth / 2);
                    const y = startY + (r * cellHeight) + (cellHeight / 2) + 5;
                    doc.text(txt, x, y, { align: "center" });
                }
            }
        }

        // Linea di taglio tratteggiata (tranne ultima della pagina)
        if (pageIdx < 3) {
            doc.setLineDashPattern([2, 2], 0);
            doc.line(5, startY + (3 * cellHeight) + 3, 205, startY + (3 * cellHeight) + 3);
            doc.setLineDashPattern([], 0);
        }
    }

    doc.save("tombola_professionale.pdf");
}
</script>

</body>
</html>
