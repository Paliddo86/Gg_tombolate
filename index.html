<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Generatore cartelle GG</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        .no-print { 
            background: #fff; padding: 20px; text-align: center;
            border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 1000;
        }
        .controls { display: flex; justify-content: center; gap: 15px; align-items: flex-end; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; border: none; font-weight: bold; border-radius: 4px; color: white; }
        .btn-gen { background: #3498db; }
        .btn-pdf { background: #27ae60; }
        
        #preview-area { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .preview-page { 
            background: white; width: 210mm; height: 297mm; 
            margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
            padding: 10mm 10.5mm; box-sizing: border-box; overflow: hidden;
        }
        .preview-cartella { margin-bottom: 12mm; width: 189mm; margin-left: auto; margin-right: auto; }
        .preview-header { 
            display: flex; justify-content: space-between; font-size: 13px; 
            padding: 4px 8px; border: 2px solid #000; border-bottom: none;
            background: #f9f9f9;
        }
        .preview-table { width: 189mm; border-collapse: collapse; border: 2px solid #000; table-layout: fixed; }
        .preview-table td { 
            border: 1.5px solid #000; height: 18mm; text-align: center; 
            font-size: 34px; font-weight: 900; font-family: sans-serif;
        }
        .empty { background: #fff; }
        .cut-line { border-bottom: 1px dashed #aaa; margin-top: 8mm; width: 100%; }
    </style>
</head>
<body>

<div class="no-print">
    <div class="controls">
        <div style="text-align:left">
            <label style="font-size:12px; font-weight:bold">TITOLO (Maiuscole/Minuscole come scritte)</label><br>
            <input type="text" id="titoloInput" value="Tombola Gruppo Giovani V. Nigro - Prima mano" style="width: 350px;">
        </div>
        <div style="text-align:left">
            <label style="font-size:11px; font-weight:bold">Q.TÀ</label><br>
            <input type="number" id="qty" value="6" min="1" style="width: 60px;">
        </div>
        <button class="btn-gen" onclick="renderPreview()">GENERA ANTEPRIMA</button>
        <button class="btn-pdf" onclick="generatePDF()">SCARICA PDF</button>
    </div>
</div>

<div id="preview-area"></div>

<script>
const { jsPDF } = window.jspdf;
let currentCartelle = [];

// Mescolamento Fisher-Yates per una casualità reale
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

/**
 * Algoritmo a "Sestina": Genera 6 cartelle usando tutti i 90 numeri.
 * Garantisce 5 numeri per riga e 15 per cartella.
 */
function generateSestina() {
    let success = false;
    let sestina = [];

    while (!success) {
        sestina = Array.from({ length: 6 }, () => 
            Array.from({ length: 3 }, () => Array(9).fill(null))
        );

        let numbersByCol = Array.from({ length: 9 }, (_, i) => {
            let min = (i === 0) ? 1 : i * 10;
            let max = (i === 8) ? 90 : i * 10 + 9;
            let list = [];
            for (let n = min; n <= max; n++) list.push(n);
            return shuffle(list);
        });

        let possible = true;
        for (let c = 0; c < 9; c++) {
            let colNums = numbersByCol[c];
            // Ogni cartella deve avere almeno un numero in questa colonna
            let cardIndices = shuffle([0, 1, 2, 3, 4, 5]);
            
            for (let cardIdx of cardIndices) {
                let n = colNums.pop();
                let rows = shuffle([0, 1, 2]);
                let placed = false;
                for (let r of rows) {
                    let rowCount = sestina[cardIdx][r].filter(x => x !== null).length;
                    if (sestina[cardIdx][r][c] === null && rowCount < 5) {
                        sestina[cardIdx][r][c] = n;
                        placed = true;
                        break;
                    }
                }
                if (!placed) { possible = false; break; }
            }
            if (!possible) break;

            // Distribuisci i numeri restanti della colonna nelle cartelle
            while (colNums.length > 0) {
                let n = colNums.pop();
                let cardIndicesReshuffled = shuffle([0, 1, 2, 3, 4, 5]);
                let placed = false;
                for (let cardIdx of cardIndicesReshuffled) {
                    let rows = shuffle([0, 1, 2]);
                    for (let r of rows) {
                        let rowCount = sestina[cardIdx][r].filter(x => x !== null).length;
                        if (sestina[cardIdx][r][c] === null && rowCount < 5) {
                            sestina[cardIdx][r][c] = n;
                            placed = true;
                            break;
                        }
                    }
                    if (placed) break;
                }
                if (!placed) { possible = false; break; }
            }
            if (!possible) break;
        }

        if (possible) {
            // Verifica finale: ogni riga deve avere ESATTAMENTE 5 numeri
            let totalValid = sestina.every(matrix => 
                matrix.every(row => row.filter(x => x !== null).length === 5)
            );
            if (totalValid) success = true;
        }
    }

    // Ordinamento verticale dei numeri nelle colonne
    sestina.forEach(matrix => {
        for (let c = 0; c < 9; c++) {
            let vals = [];
            for (let r = 0; r < 3; r++) if (matrix[r][c] !== null) vals.push(matrix[r][c]);
            vals.sort((a, b) => a - b);
            let idx = 0;
            for (let r = 0; r < 3; r++) if (matrix[r][c] !== null) matrix[r][c] = vals[idx++];
        }
    });

    return sestina;
}

function renderPreview() {
    const area = document.getElementById('preview-area');
    const qty = parseInt(document.getElementById('qty').value);
    const titolo = document.getElementById('titoloInput').value;
    area.innerHTML = ''; currentCartelle = [];

    let generated = 0;
    while (generated < qty) {
        let sestina = generateSestina();
        for (let j = 0; j < 6 && generated < qty; j++) {
            currentCartelle.push(sestina[j]);
            generated++;
        }
    }

    let currentPageDiv;
    for (let i = 0; i < currentCartelle.length; i++) {
        if (i % 4 === 0) {
            currentPageDiv = document.createElement('div');
            currentPageDiv.className = 'preview-page';
            area.appendChild(currentPageDiv);
        }
        const matrix = currentCartelle[i];
        const wrapper = document.createElement('div');
        wrapper.className = 'preview-cartella';
        wrapper.innerHTML = `
            <div class="preview-header">
                <span>${titolo}</span>
                <span style="color: #333;">${i+1}</span>
            </div>
            <table class="preview-table">
                ${matrix.map(row => `<tr>${row.map(c => `<td class="${c?'':'empty'}">${c||''}</td>`).join('')}</tr>`).join('')}
            </table>
            ${(i + 1) % 4 !== 0 ? '<div class="cut-line"></div>' : ''}
        `;
        currentPageDiv.appendChild(wrapper);
    }
}

function generatePDF() {
    if (currentCartelle.length === 0) return;
    const doc = new jsPDF('p', 'mm', 'a4');
    const titolo = document.getElementById('titoloInput').value;
    const cellW = 21, cellH = 18, cardWidth = 189, marginX = (210 - cardWidth) / 2;
    const headerH = 7, stepY = 70; 

    currentCartelle.forEach((matrix, i) => {
        const pageIdx = i % 4;
        if (i > 0 && pageIdx === 0) doc.addPage();
        const startY = 15 + (pageIdx * stepY);

        doc.setLineWidth(0.5);
        doc.rect(marginX, startY - headerH, cardWidth, headerH);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text(titolo, marginX + 3, startY - 2.5);
        doc.setFont("helvetica", "normal");
        doc.text(`${i + 1}`, marginX + cardWidth - 3, startY - 2.5, { align: "right" });

        for (let r = 0; r <= 3; r++) doc.line(marginX, startY + (r * cellH), marginX + cardWidth, startY + (r * cellH));
        for (let c = 0; c <= 9; c++) doc.line(marginX + (c * cellW), startY, marginX + (c * cellW), startY + (3 * cellH));

        doc.setFont("helvetica", "bold");
        doc.setFontSize(36);
        matrix.forEach((row, rIdx) => {
            row.forEach((num, cIdx) => {
                if (num) {
                    const x = marginX + (cIdx * cellW) + (cellW / 2);
                    const y = startY + (rIdx * cellH) + (cellH / 2) + 5.5;
                    doc.text(num.toString(), x, y, { align: "center" });
                }
            });
        });

        if (pageIdx < 3) {
            doc.setLineWidth(0.1);
            doc.setLineDashPattern([2, 2], 0);
            doc.line(5, startY + (cellH * 3) + 6, 205, startY + (cellH * 3) + 6);
            doc.setLineDashPattern([], 0);
        }
    });
    doc.save(titolo + "_" + currentCartelle.length + ".pdf");
}

renderPreview();
</script>
</body>
</html>
